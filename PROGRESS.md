

++++++
# 阶段性总结
### 1) 功能迭代（2026-02-25）

完成一批面向可用性与运维效率的改进：

* Workspace 名称内联编辑、备忘录（notes）支持、任务编号按工作区独立递增
* GPU 展示修复（显存利用率/计算利用率显示更准确）
* 多 GPU 支持（`gpu_indices` + `CUDA_VISIBLE_DEVICES` 透传）
* 任务完成通知增强（浏览器通知 + 页内 toast 双通道，权限被拒时仍可提醒）

**关键教训**

* 关键状态提醒不能依赖单一通知通道，必须有浏览器通知 + 应用内兜底。
* UI 显示指标要明确区分不同含义（显存 vs compute），避免“看起来正常但信息误导”。

---

### 2) SSH / SSH_CONTAINER 执行链路稳定性修复（2026-02-24 ~ 2026-02-25）

系统性修复了 SSH/容器任务“创建即失败、路径错误、命令执行在错误环境、日志无输出”等问题，包括：

* 统一 SSH 连接参数构建（用户/端口/BatchMode）
* 正确区分 canonical URL 与远程真实路径（避免把 `ssh://...` 当本地路径）
* SSH+Container 命令必须通过 `docker exec` 在容器内执行
* 修复 zsh 支持（`login_shell` 保存、`.zshrc` source、变量名冲突）
* 修复 codex 参数兼容（模型参数传递、审批参数变更、代理配置在非交互 shell 生效）
* 修复 SSH 日志实时输出（避免 `tee` 缓冲；`tail -F` 处理竞态）
* 新增工作区健康检查接口与前端健康状态徽章（创建任务前先校验仓库可用性）

**关键教训**

* **SSH 命令构建必须集中封装**，不能在不同模块各自拼接（端口/用户/路径/容器层级极易漏）。
* **非交互 shell ≠ 交互 shell**：alias、profile、`~/.zshrc`、代理配置都可能不生效，必须显式处理。
* **双层 shell（SSH + docker exec）必须严控转义**；动态内容优先用 base64/临时脚本，避免引号地狱与变量提前展开。
* **实时日志场景不要用 `tee` 写文件**（块缓冲会让前端“看起来卡死”）；`tail -F` 比 `tail -f` 更稳健。

---

### 3) 数据库与异步 ORM 稳定性修复（2026-02-23 ~ 2026-02-24）

修复高并发下 SQLite 与异步 SQLAlchemy 引起的多类问题：

* `database is locked`、`MissingGreenlet`、detached instance、HTTP 500 但状态已落库
* 调整会话生命周期与 commit 后返回逻辑
* 流式日志接口改为短生命周期 session，避免长连接持有事务
* SQLite 开启 WAL / busy_timeout，并改为显式提交策略
* 修复 Runner 心跳时间比较中的 naive/aware datetime 混用问题

**关键教训**

* **异步 SQLAlchemy 中，commit 后不要依赖 ORM 实例状态**；返回值与清理逻辑应使用“快照值/重新查询”。
* **流式接口禁止长期占用 DB session**，尤其在 SQLite 下会放大锁冲突。
* **SQLite 并发默认启用 WAL + busy_timeout**，事务边界要显式可控。
* **时间比较前必须统一时区归一化**，不能假设数据库读出来的 datetime 自带 tzinfo。

---

### 4) 任务生命周期 / Merge / Retry 语义加固（2026-02-20 ~ 2026-02-24）

围绕任务状态机与 Git worktree 流程做了多轮加固：

* Retry 语义改为**原任务原地重排队**（不新建任务、不新建 worktree）
* Merge 流程增强：自动恢复残留 merge 状态、处理脏工作区、worktree 缺失时按分支继续合并、AI 兜底后按 Git 实际状态判定
* 新增 `mark-done` 显式完结接口，避免 reconciler 自动推进审批语义
* 增强 worktree 有效性校验与自动修复（路径存在 ≠ 可复用）

**关键教训**

* **“重试”优先定义为状态机流转，而不是复制实体**（避免上下文割裂）。
* **Reconciler 只能修引用/一致性，不能替代用户审批语义**（不能自动把 `TO_BE_REVIEW` 推成 `DONE`）。
* **Merge 必须遵循“规则优先、AI 兜底、最终以 Git 真实状态为准”**。
* **路径存在不代表 worktree 有效**，所有复用前都要做 Git 级校验。

---

### 5) 平台兼容性与执行器鲁棒性（Windows / CLI / 长文本 / 日志）

完成多项平台与执行链路修复：

* Windows shell 优先级统一（git-bash > cmd > powershell）并集中在 `cli_resolver`
* Windows CLI 可执行文件解析修复（避免 PowerShell alias/路径导致 WinError2）
* 长 prompt 改为 stdin 传递（避免命令行长度限制）
* 子进程日志读取增大 `readline` 上限（修复超长单行导致 `LimitOverrunError`）
* SSE 日志多行解析修复

**关键教训**

* **大文本输入统一走 stdin/文件通道**，不要依赖命令行参数长度上限。
* **Windows shell 选择必须走单一策略入口**，禁止各适配器各自实现。
* **流式日志协议要按“多行/超长行”设计**，不能假设每条事件只有单行且很短。

---

### 6) 通知、可观察性与产品体验

围绕任务完成与待审核的可见性做了持续改进：

* 全局通知器从仅 `TO_BE_REVIEW` 扩展到终态集合（`TO_BE_REVIEW / DONE / FAILED`）
* 修复首次观测即终态时漏报问题
* 新增通知开关并接入运行态监听
* Retry/完成类操作增加即时 UI 反馈，减少“点击后无感知”

**关键教训**

* **提醒逻辑应按“终态集合”建模，而不是绑死单一状态**。
* **状态变化通知要覆盖“首次观测态”**，不能只依赖前后态对比。
* **触发后台动作的按钮必须给即时反馈**（toast/提示条/loading 文案）。

---

### 7) 工程化与交付（CI/CD、回归测试、分支协作）

建立 CI/CD 基线并补齐关键回归验证：

* GitHub CI 覆盖后端/前端构建与基础回归
* main 分支自动生成交付产物
* 多个高风险路径增加回归脚本（重试、merge、mark-done、数据库稳定性等）
* 多次并行分支合并暴露 `PROGRESS.md` 文本冲突问题，流程上加强 rebase/拆分条目习惯

**关键教训**

* **状态机/调度/合并路径的改动必须配套回归测试**（尤其是“返回码与最终状态一致性”）。
* **新增 backend / 适配器能力要从单一枚举源派生，避免字符串散落导致能力不一致**。
* **并行分支频繁修改同一沉淀文档时，先 rebase 或拆分条目，降低冲突概率**。
* **合并策略应依赖 CI 必过检查，不绕过质量闸门**。

---

## 最值得保留的“总教训”（可放在文末）

1. **统一入口比局部修补更重要**
   SSH 连接参数、Windows shell 选择、CLI 执行策略、路径解析都必须集中管理，否则同类 bug 会反复出现。

2. **状态机语义要清晰，自动化边界要克制**
   Retry 是原地重试；Reconciler 只修一致性，不推进审批；任务完结必须是显式用户动作（merge 或 mark-done）。

3. **异步 + SQLite 的稳定性核心在“短会话、显式事务、避免 post-commit ORM 访问”**
   流式接口尤其要避免持有长事务；commit 后使用快照/重查，不依赖 ORM 对象状态。

4. **跨环境执行（SSH / 容器 / Windows / 非交互 shell）是高风险区，必须优先做防御性设计**
   显式 source、统一转义、stdin 传大文本、代理配置兼容、日志链路实时性都要预先考虑。

5. **关键链路改动必须有回归测试与 CI 兜底**
   特别是 merge/retry/mark-done/scheduler/DB 稳定性路径，单点修复很容易引入新的状态机回归。

